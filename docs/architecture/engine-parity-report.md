# Engine parity report

## What exists today
- `/api/chat` renders the engine choice by calling `loadChatModelSettings`, which merges `presetId`, session-provided overrides, and the `CHAT_ENGINE` env var (defaulting to `lc`), then routes to `langchain_chat` or `native_chat` based on the resolved engine (pages/api/chat.ts:9-35; lib/server/chat-settings.ts:232-638; types/chat-config.ts:23-48).
- The LangChain path loads `pages/api/langchain_chat.ts`, which defers to `lib/server/api/langchain_chat_entry.ts` and then `lib/server/api/langchain_chat_impl_heavy.ts`, where guardrails, telemetry, retrieval, caching, and streaming are wired through LangChain `Runnable`s, Supabase vector stores, and Langfuse buffers (pages/api/langchain_chat.ts:1-41; lib/server/api/langchain_chat_entry.ts:1-44; lib/server/api/langchain_chat_impl_heavy.ts:168-3085).
- The native path lives in `pages/api/native_chat.ts`; it reuses the same guardrails and runtime snapshot but streams through `streamChatCompletion`, respects `requireLocal`, enforces local backend availability, and emits telemetry/caching from within a single module that talks directly to Supabase RPCs and local LLM clients (pages/api/native_chat.ts:1-375; pages/api/native_chat.ts:988-1405; lib/server/chat-settings.ts:417-556; lib/rag/retrieval.ts:17-64; lib/server/chat-rag-utils.ts:1-95).

## Parity matrix
| Capability | LangChain (`lc`) | Native (`native`) | Parity status | Drift risk | Recommendation |
| --- | --- | --- | --- | --- | --- |
| **A) Intent routing + guardrail routes** | Normalized question → `routeQuestion` → `guardrailRoute` → `telemetryBuffer` events + `buildChatConfigSnapshot`, so guardrail metadata flows into Langfuse/headers (lib/server/api/langchain_chat_impl_heavy.ts:2010-2056; lib/server/chat-guardrails.ts:504-543; lib/server/api/langchain_chat_impl_heavy.ts:2274-2351). | Same `routeQuestion` + `guardrailRoute` values are passed into `langfuse.trace`, `buildChatConfigSnapshot`, and the PostHog event, and `applyHistoryWindow` populates the guardrail header (pages/api/native_chat.ts:245-352; lib/server/chat-guardrails.ts:504-543; pages/api/native_chat.ts:347-414; pages/api/native_chat.ts:820-868). | PASS | Low | keep |
| **B) Retrieval pipeline (reverse-RAG, HyDE, reranker, MMR/quota, citations)** | `buildRagRetrievalChain` orchestrates reverse-RAG, HyDE, `applyRanker`, quota/MMR selection, citation payload, and auto/multi-query decisioning before caching the context; telemetry traces the decisions that feed into `decisionSignature` (lib/server/langchain/ragRetrievalChain.ts:168-360; lib/server/api/langchain_chat_impl_heavy.ts:748-1160; lib/server/chat-guardrails.ts:545-700; lib/server/api/langchain_chat_impl_heavy.ts:986-1115). | `processPreRetrieval` + `matchRagChunksForConfig` + `applyRanker` + `buildContextWindow` produce reverse-RAG/HyDE cues, Supabase retrieval, reranking/quota, and citations, but there is no auto/multi-query decision/multi-candidate merge, so fallback always uses the base retrieval pass (lib/server/chat-rag-utils.ts:1-95; lib/rag/retrieval.ts:17-64; pages/api/native_chat.ts:569-840; lib/server/chat-guardrails.ts:545-700). | PARTIAL | Medium | align |
| **C) History window, summary memory, cache invalidation** | `applyHistoryWindow` filters/trims history and produces `summaryMemory`, which feeds into the prompt, metadata, and `responseCacheKey` via `historySummaryHash`, so summary changes change the cache key (lib/server/chat-guardrails.ts:545-587; lib/server/api/langchain_chat_impl_heavy.ts:2010-2056; lib/server/api/langchain_chat_impl_heavy.ts:1220-1275; lib/server/api/langchain_chat_impl_heavy.ts:2445-2475). | `applyHistoryWindow` also trims history and adds `summaryBlock` to the prompt plus `X-Guardrail-Meta`, but the response cache key only covers `presetId`, `intent`, and `messages`, so cached streams can survive summary updates (pages/api/native_chat.ts:245-352; pages/api/native_chat.ts:469-496; pages/api/native_chat.ts:880-940). | PARTIAL | Medium | align |
| **D) Streaming, abort semantics & finish reason** | `createRequestAbortSignal` guards the LangChain run, streaming passes chunks through `renderStreamChunk`, and `finishReason`/`buildSafeTraceOutputSummary` record success/aborted/error states via Langfuse (lib/server/langchain/abort.ts:1-36; lib/server/api/langchain_chat_impl_heavy.ts:1360-1500; lib/server/api/langchain_chat_impl_heavy.ts:1447-1465; lib/server/api/langchain_chat_impl_heavy.ts:2990-3078). | `streamChatCompletion` yields provider-specific streams and prints citations, but there is no abort-signal hookup or rich `finishReason` reporting (pages/api/native_chat.ts:988-1050; pages/api/native_chat.ts:1031-1065; pages/api/native_chat.ts:1160-1405). | PARTIAL | Medium | align |
| **E) Telemetry (Langfuse spans/metadata + PostHog fields)** | `telemetryBuffer` emits `handler-start`, guardrail/admin/telemetry events, and `cache-hit`/`stream-success`/`handler-error`; Langfuse traces are created/updated with guardrail metadata, and PostHog events include latency breakdown, cache-enabled flags, and retrieval booleans (lib/server/api/langchain_chat_impl_heavy.ts:1831-2415; lib/server/api/langchain_chat_impl_heavy.ts:2473-2839; lib/server/api/langchain_chat_impl_heavy.ts:2930-2985). | Langfuse trace is created directly, but native only updates it with the basic guardrail config, and the PostHog capture omits `response/retrieval_cache_enabled`, latency split, and retrieval attempt/use markers (pages/api/native_chat.ts:347-414; pages/api/native_chat.ts:431-462; pages/api/native_chat.ts:485-520; pages/api/native_chat.ts:827-868). | PARTIAL | High | align |
| **F) Cache semantics (response/retrieval key scope + hit/enabled booleans)** | Response key fingerprints guardrails, runtime flags (reverse-RAG, HyDE, ranker), `decisionSignature`, provider/model, and `summaryHash`, while retrieval key includes multi-query configuration; `cacheMeta` is merged into trace metadata whenever hits occur (lib/server/api/langchain_chat_impl_heavy.ts:227-260; lib/server/api/langchain_chat_impl_heavy.ts:2445-2475; lib/server/api/langchain_chat_impl_heavy.ts:2120-2165). | Native keys only include `presetId`, `intent`, `messages` (response) and `presetId`, `question`, `ragTopK`, `similarityThreshold` (retrieval), and trace metadata never records `cache_enabled` flags, so hit semantics are blurred with the actual cache-enabled state (pages/api/native_chat.ts:311-345; pages/api/native_chat.ts:469-520). | PARTIAL | Medium | align |
| **G) Operational independence / fallback capability** | LangChain relies on the LangChain bundle, Supabase vector store, and the heavy runtime, so the LC stack is the primary execution path and cannot act as the fallback when those dependencies fail (pages/api/langchain_chat.ts:1-41; lib/server/api/langchain_chat_impl_heavy.ts:168-420). | Runtime resolver now exposes `runtime.enforcement`, so both LangChain and native engines respond consistently (pages/api/langchain_chat_impl_heavy.ts:2473-2850; pages/api/native_chat.ts:431-1050). Native still serves as the optional fallback when preset/routing forces `requireLocal` or the LC stack is unavailable. | FAIL¹ | Low | keep |

¹Capability G is intentionally asymmetric: LangChain is the primary stack, and native provides the fallback.

## Risk assessment
- Native lacks Langfuse/PostHog coverage for cache-enabled flags and retrieval diagnostics, so fallback traffic cannot be compared apples-to-apples with LC and may silently hide regression signals (pages/api/native_chat.ts:347-462 vs lib/server/api/langchain_chat_impl_heavy.ts:1831-2415).  
- Native caches ignore `summaryHash`/runtime flags, so local LLM turns reuse stale contexts even when guardrail settings or history summaries change, which will make the fallback drift from LC’s expectations (pages/api/native_chat.ts:469-520 vs lib/server/api/langchain_chat_impl_heavy.ts:227-260; lib/server/api/langchain_chat_impl_heavy.ts:2445-2475).  
- The autotuning/multi-query stack never runs in native, so complex prompts (auto HyDE/rewrite) that LC handles gracefully could fall back to much weaker retrieval, leading to surprise behavior when native is engaged inside `requireLocal` or when LC fails (lib/server/api/langchain_chat_impl_heavy.ts:748-1115; pages/api/native_chat.ts:569-840).

## Recommendation
Run Option 2: keep the native engine as a *minimal, guardrail-aware fallback* behind LangChain. LC remains the primary path for production traffic, but native must stay operational whenever local backends are requested or LangChain dependencies fail. However, the parity gaps in retrieval auto logic, caching, abort handling, and telemetry should be shrunk so fallback behavior is predictable and observable; otherwise, the fallback will regress silently as features evolve in LC.

## Next actions
### Option 1 – remove native
- Remove `pages/api/native_chat.ts`, its helper functions (`streamChatCompletion`, `processPreRetrieval` usage, etc.), and the `native` option from `types/chat-config.ts` plus any admin allowlists (`components/admin/chat-config/*.tsx`).  
- Delete or archive local-LLM helpers under `lib/local-llm/` and adjust the smoke/matrix tests (`scripts/smoke/test-local-llm-matrix.ts`, `scripts/smoke/test-local-llm-deep.ts`) that target `/api/native_chat`.  
- Update docs (`docs/operations/local-llm-operations-checklist.md`, `docs/architecture/rag-architecture.md`, `docs/testing/*.md`) to describe the single LC path.
### Option 2 – keep native fallback (recommended)
- Define the minimal fallback contract around guardrail metadata, caching, and telemetry: ensure native shares `response_cache_hit`, `retrieval_cache_hit`, `response_cache_enabled`, `retrieval_cache_enabled`, `guardrail_route`, and defined finish reasons with Langfuse/PostHog in the same shape as LC (`pages/api/native_chat.ts:311-868`; `lib/server/api/langchain_chat_impl_heavy.ts:2120-2415`).  
- Align caching keys to include guardrail/runtime flags/summary hashes (or document the accepted divergence) and use `createRequestAbortSignal` when streaming local backends to avoid leaked runs (`pages/api/native_chat.ts:469-520`; `lib/server/api/langchain_chat_impl_heavy.ts:2010-2475`; `lib/server/langchain/abort.ts:1-36`).  
- Run/maintain the local LLM matrix tests (`scripts/smoke/test-local-llm-matrix.ts`, `scripts/smoke/test-local-llm-deep.ts`) and the LangChain `api` smoke test (`scripts/smoke/chat-api-smoke.ts`) to keep fallback coverage in sync.
